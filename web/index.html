<!DOCTYPE html>
<html>
<head>
<meta charset="gbk"/>
<title>jsdc</title>
<style>
body{font:12px/1.25 arail;background-color:#fff;line-height:1.25;}

.jssc ol{font-family:Consolas,momospace,"宋体","Courier New";font-size:12px;}
.jssc li:hover{background:#FF9;}
.jssc .number{color:#088;}
.jssc .keyword{color:#33f;}
.jssc .comment{color:#393;}
.jssc .string{color:#a33;}
.jssc .template{color:#993;}
.jssc .reg, .jssc .annot, .jssc .head, .jssc .declare{color:#999;}
.jssc .annot{font-style:italic;}
.jssc .attr{color:#909;}
.jssc .tags, .jssc .cdata{color:#c96;}
.jssc .namespace{color:#f00;}
.jssc .depth{color:#fc0;}
.jssc .java .keyword{color:#909;}

.jssc{position:relative;}
.jssc p{margin:10px 0;color:#79a;text-indent:2em;font-weight:700;font-family:"Verdana","\5b8b\4f53";}
.jssc .error{color:#f33;}
.jssc .copy{display:block;position:absolute;top:0;right:0;cursor:pointer;color:#39f;}
.jssc ol{margin:0;padding:0;overflow:auto;border:1px solid #ccc;background-color:#eee;font-family:Consolas,momospace,"\5b8b\4f53","Courier New";font-size:13px;clear:both;}
.jssc ol li{margin:0;padding-left:10px;border-left:1px solid #abc;background-color:#fff;color:#333;word-wrap:break-word;word-break:break-all;}
.jssc ol li:hover{background-color:#ff9;}
.jssc ol li.even{background-color:#eee;}
.jssc ol li .error{background-color:#f33;}
.jssc ol .fold{background:#eee;font-style:italic;}
.jssc ol .fold:after{content:"...";}
.jssc ol .hide{position:absolute;visibility:hidden;}

.kineticjs-content{margin:10px 0;}
</style>
</head>
<body>
<h3>var前置至作用域顶部</h3>
<pre>
<code class="brush:js">var a = 1, b, c = 2;{}
function test(){
	var a;;
}
var a,b,c;
if(true){}
else if(true){
}
else {}
do {
	var a;
} while(true);
for(var i = 0, len = 10; i < len; i++) {
}</code>
<!--code class="brush:js">//some code
var a = 1;
function f() {
	/test/;
	var a = 2,
		b = 3;
	function f2() {
		var d = 5;
		//
		var f = 6;
		var e;
	}
}</code-->
</pre>
<script src="Ai.js"></script>
<script src="kinetic-v4.4.0.min.js"></script>
<script>
var w = 0, h = 0;
function draw(i, res, node) {
	if(typeof res == 'string') {
		return;
	}
	var div = document.createElement('div');
	div.id = 'container' + i;
	node.parentNode.insertBefore(div, node);
	var stage = new Kinetic.Stage({
			container: div.id,
			width: 0,
			height: 0
		}),
		layer = new Kinetic.Layer();
	drawNode(layer, res, 0, 0, 0, 0);
	stage.add(layer);
	stage.setWidth(w);
	stage.setHeight(h + 30);
}
function drawNode(layer, node, x, index, parent, sibling) {
	if(index > 0) {
		h += 30;
	}
	var isToken = node.name() == 'Token',
		text = new Kinetic.Text({
			x: x + 5,
			y: h + 6,
			text: isToken ? node.leaves().content() : node.name(),
			width: 68,
			height: 16,
			align: 'center',
			fill: isToken ? '#6CF' : '#f60',
			fontSize: 12,
			fontFamily: 'Verdana'
		}),
		rect = new Kinetic.Rect({
			x: x + 2,
			y: h + 2,
			width: 74,
			height: 20,
			fill: isToken ? '#FFF' : '#F9F9F9',
			stroke: isToken ? '#CCC' : '#808080',
			cornerRadius: 10
		});
	layer.add(rect);
	layer.add(text);
	var x2 = x + 88;
	if(parent) {
		var line = new Kinetic.Line({
			points: [x - 10, parent.getY() + 10, x + 2, rect.getY() + 10],
			stroke: '#6F9',
			strokeWidth: 1,
			lineJion: 'round',
			dashArray: [1, 1]
		});
		layer.add(line);
	}
	if(!isToken) {
		var sib = null;
		node.leaves().forEach(function(leaf, index) {
			drawNode(layer, leaf, x2, index, rect, sib);
			sib = leaf;
		});
	}
	w = Math.max(w, x2);
}
require(['jsdc', 'jssc'], function(jsdc, jssc) {
	var nodes = Array.prototype.slice.call(document.getElementsByTagName('code'), 0);
	nodes.forEach(function(node, i) {
		var res = jsdc.parse(node.textContent || node.innerText ||  node.firstChild.nodeValue),
			pre = node.parentNode,
			ncode = document.createElement('code'),
			npre = document.createElement('pre');
		ncode.innerHTML = 'todo...';
		ncode.className = node.className;
		npre.appendChild(ncode);
		pre.parentNode.insertBefore(npre, pre.nextSibling);
		draw(i, res, npre.nextSibling);
	});
	jssc.exec();
});
</script>
</body>
</html>